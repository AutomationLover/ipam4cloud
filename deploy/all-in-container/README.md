# All-in-Container Deployment

This deployment option runs all IPAM4Cloud services (database, backend, frontend) in Docker containers on a single EC2 instance.

## Overview

- **Database**: PostgreSQL container
- **Backend**: FastAPI backend container
- **Frontend**: Vue.js admin and read-only portals
- **AWS Sync**: Container for VPC synchronization

All services run on a single EC2 instance using Docker Compose.

## Prerequisites

1. **AWS Account** with appropriate permissions
2. **Terraform** >= 1.0 installed
3. **AWS CLI** configured with credentials
4. **VPC and Subnet** IDs where you want to deploy

## Quick Start

### 1. Configure Variables

```bash
cd deploy/all-in-container
```

Edit `terraform.tfvars` and update:
- `aws_region`: Your AWS region
- `project_name`: Your project name (optional, defaults to "ipam4cloud")
- `environment`: Environment name (optional, defaults to "dev")
- `instance_type`: EC2 instance type (optional, defaults to "t3.xlarge")
- `repository_url`: Git repository URL (optional)

Edit `network.auto.tfvars` and update:
- `vpc_id`: Your VPC ID (replace the placeholder)
- `subnet_id`: Your subnet ID (replace the placeholder)

**Note**: SSH key pairs are automatically generated by Terraform. The private key will be saved as `${project_name}-${environment}-allinone-deployer-key` (e.g., `ipam4cloud-dev-allinone-deployer-key`) in the current directory. If you prefer to use an existing AWS key pair, set `create_key_pair = false` and `existing_key_name = "your-key-name"` in `terraform.tfvars`.

### 2. Deploy Infrastructure

```bash
terraform init
terraform plan
terraform apply
```

### 3. Access the Application

After deployment, Terraform will output:
- Instance public IP
- Private key file path
- SSH command
- Application URLs

Access the services:
- **Admin Portal**: http://<instance-public-ip>:8080
- **Read-Only Portal**: http://<instance-public-ip>:8081
- **Backend API**: http://<instance-public-ip>:8000

### 4. SSH to Instance

If a new key pair was created (default), use:
```bash
ssh -i ipam4cloud-dev-allinone-deployer-key ec2-user@<instance-public-ip>
```

The exact key filename will be shown in the Terraform output (`private_key_file`). The key name format is `${project_name}-${environment}-allinone-deployer-key`.

Check initialization status:
```bash
sudo cloud-init status --wait
sudo tail -20 /var/log/user-data.log
```

## Configuration

### Variables

| Variable | Description | Required | Default | File |
|----------|-------------|----------|---------|------|
| `aws_region` | AWS region for deployment | Yes | - | `terraform.tfvars` |
| `vpc_id` | VPC ID where instance will be deployed | Yes | - | `network.auto.tfvars` |
| `subnet_id` | Subnet ID for EC2 instance | Yes | - | `network.auto.tfvars` |
| `project_name` | Project name for resource naming | No | `ipam4cloud` | `terraform.tfvars` |
| `environment` | Environment name (dev/staging/prod) | No | `dev` | `terraform.tfvars` |
| `instance_type` | EC2 instance type | No | `t3.xlarge` | `terraform.tfvars` |
| `root_volume_size` | Root volume size in GB | No | `50` | `terraform.tfvars` |
| `repository_url` | Git repository URL | No | GitHub default | `terraform.tfvars` |
| `create_key_pair` | Automatically create new SSH key pair | No | `true` | `terraform.tfvars` |
| `existing_key_name` | Existing AWS key pair name (if `create_key_pair = false`) | Conditional | - | `terraform.tfvars` |

**Note**: SSH key pairs are automatically generated by Terraform when `create_key_pair = true` (default). The private key is saved as `${project_name}-${environment}-allinone-deployer-key` and the public key as `${project_name}-${environment}-allinone-deployer-key.pub` in the deployment directory.

## Managing the Application

Once deployed, you can SSH to the instance and use `manage.sh`:

```bash
# SSH to instance (use the key file shown in Terraform output)
ssh -i ipam4cloud-dev-allinone-deployer-key ec2-user@<instance-public-ip>

# Navigate to application directory
cd ~/ipam4cloud

# Use manage.sh to control containers
./manage.sh start          # Start all containers
./manage.sh stop           # Stop all containers
./manage.sh restart        # Restart containers
./manage.sh logs           # View logs
./manage.sh status         # Check status
```

## Troubleshooting

### Instance Not Initializing

1. Check cloud-init status:
   ```bash
   sudo cloud-init status
   ```

2. View user-data logs:
   ```bash
   sudo tail -f /var/log/user-data.log
   ```

3. Check Docker installation:
   ```bash
   docker --version
   docker compose version
   ```

### Application Not Accessible

1. Check security group rules (ports 22, 8000, 8080, 8081 should be open)
2. Verify containers are running:
   ```bash
   docker ps
   ```
3. Check container logs:
   ```bash
   cd ~/ipam4cloud
   ./manage.sh logs
   ```

### Database Issues

1. Check PostgreSQL container:
   ```bash
   docker ps | grep postgres
   docker logs prefix_db
   ```

2. Verify database connection:
   ```bash
   docker exec -it prefix_db psql -U prefix_user -d prefix_management
   ```

## Cleanup

To destroy all resources:

```bash
terraform destroy
```

**Warning**: This will delete the EC2 instance and all data. Ensure you have backups if needed.

## Cost Estimation

- **EC2 t3.xlarge**: ~$150/month (varies by region)
- **EBS Storage (50GB gp3)**: ~$4/month
- **Data Transfer**: Varies

Total estimated cost: ~$154/month (excluding data transfer)

## Security Considerations

1. **SSH Access**: Security group allows SSH from 0.0.0.0/0. Consider restricting to your IP.
2. **Database Port**: Port 5432 is open to 0.0.0.0/0. Consider restricting access.
3. **Application Ports**: Ports 8000, 8080, 8081 are open. Consider adding authentication.
4. **Key Management**: 
   - SSH keys are automatically generated by Terraform and saved locally
   - Keep your private key (`*-deployer-key`) secure and never commit it to git
   - The `.gitignore` file already excludes these keys
5. **Sensitive Files**: 
   - `network.auto.tfvars` contains VPC and subnet IDs specific to your environment
   - This file is gitignored - never commit it to version control

## Support

For issues or questions:
1. Check the [Design Document](../DESIGN.md) for architecture details
2. Review Terraform outputs for connection details
3. Check AWS CloudWatch logs for EC2
4. Review application logs using `manage.sh logs`
